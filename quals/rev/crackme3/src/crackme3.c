#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include "crackme3.h"

#define MARK1                           \
 __asm__ __volatile__(  ".quad 0xc74c07caf913bfd6\n" )
#define MARK2                           \
 __asm__ __volatile__(  ".quad 0xbc6ade3ba82a4501\n" )

unsigned int MARK1_OFFSET = 0x5733a96b;

typedef us (*OF)(us, us);

typedef struct OP {
    unsigned int C0 : 1;
    unsigned int C1 : 1;
    unsigned int C2 : 1;
    unsigned int C3 : 1;
    unsigned int OPI : 6;
    unsigned int R1 : 6;
    unsigned int R2 : 6;
    unsigned int IMM : 10;
} OP;

us IS_NASTY = 0;
us A = 0;
us R[64] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
us SKIP = 0;

unsigned char S[] = {0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255};
unsigned char RCI = 0;
unsigned char RCJ = 0;

uint32_t CODE[] = {67110016, 289415296, 461382784, 486549632, 423636096, 478163072, 134231168, 427833472, 453000320, 406864000, 432030848, 134236288, 167791744, 423645312, 503338112, 406870144, 415259776, 486563968, 453010560, 507537536, 134245504, 209744000, 218133632, 134248576, 415267968, 436240512, 406881408, 478185600, 482380928, 172003456, 243307648, 134256768, 33555584, 2277573648, 134218880, 1174471680, 134218880, 2248213520, 2775168, 3426432, 2113664, 3552384, 3298432, 2238592, 3111040, 2505856, 3482752, 2706560, 3362944, 2977920, 2177152, 2651264, 2582656, 2384000, 2841728, 3616896, 2436224, 3022976, 855639946, 2933772, 119821, 333541, 935187, 1849833, 433341925, 3234305638, 5785018, 1618239, 3227478531, 1823678, 563219, 197088715, 58894526, 2342075, 66546848, 93279467, 154455704, 498056217, 185012454, 26813690, 1073189147, 284639468, 262482425, 3234699514, 4742240, 579694, 3226728723, 2115044, 3621346, 6161790, 186287387, 557941575, 35125706, 141374428, 1073412606, 778174773, 105948914, 199992676, 3235171913, 6689966, 2065944, 3225545796, 3483167, 889965, 224961592, 84114061, 252413719, 75990397, 751014092, 1072567630, 1010298619, 3237432251, 7430801, 3264673, 3229066262, 1232848, 237909114, 257311801, 1811531, 169019154, 9307846, 149692765, 135606786, 903287966, 15791321, 1072592771, 109661621, 516429681, 188287651, 252202232, 3235482911, 6007630, 440112, 3226983291, 1340537, 2287293, 188824245, 167721929, 154017193, 197043024, 97952139, 946330178, 245345591, 64072791, 1069734525, 259677423, 808084556, 3236611225, 4929196, 1411753, 3228134280, 371215, 213864517, 1131617, 133829586, 695276325, 160059888, 1070600475, 101738562, 186981809, 3235050915, 5348761, 1133234, 3226616413, 2629906, 134979138, 65181247, 1645104, 69531374, 211701505, 112662149, 224480523, 52300131, 135946488, 128153411, 164987047, 1072764174, 261799700, 392979790, 3234856479, 8260378, 4073203, 3227839048, 1552326, 563449, 191304856, 154867521, 75316263, 17954470, 107222226, 632897288, 117538743, 1069879074, 352696695, 140054352, 63966377, 3234301454, 5087974, 2803414, 3228392618, 1755955, 23723181, 160632741, 392867, 19250707, 161135724, 242172789, 145883573, 996818975, 1073713296, 220256548, 591172573, 247425926, 3234640291, 6984583, 642871, 3229594130, 4127586, 251126425, 2965566, 257329188, 182985540, 77827618, 179642661, 184913819, 53473542, 1071012510, 146900167, 842935304, 3237897940, 4211143, 1297473, 3228002280, 3373563, 222126106, 4011465, 65925916, 120879061, 367097132, 1072091362, 104229998, 323431364, 245724333, 253651566, 3234336825, 8070012, 2101118, 3225624953, 3339903, 103948072, 103711093, 2245958, 196102274, 5523827, 2035295, 138624630, 105528589, 207321909, 259785963, 75513877, 1071969261, 204420261, 213725829, 637350340, 37565608, 129474526, 3234672729, 4484571, 299221, 3226167604, 1789336, 46045924, 1064347, 137809453, 93700930, 633258240, 88236731, 3905022, 1071452752, 895347653, 3235351400, 4402289, 200745, 3226950906, 488240, 3700533, 49784673, 3444148, 119901335, 621979477, 100502969, 97246898, 1070423860, 136261686, 130495036, 170454884, 3236931009, 4718115, 519435, 3228520643, 648570, 1955219, 99425281, 216736298, 28965349, 244831884, 446669895, 1070244943, 152034524, 839317340, 160371217, 50778839, 3236785467, 6019657, 1793674, 3228402464, 1389774, 146842233, 68655052, 3362087, 141894751, 227120128, 356757599, 185481003, 171878347, 1071272145, 89708134, 113790642, 918901032, 58623070, 129201521, 3236030817, 6055515, 1860969, 3227626704, 990707, 3137397, 210314849, 927156, 165267902, 232487422, 248499302, 82527352, 77013594, 1070844873, 626214398, 3234671789, 6397964, 3990538, 3229434919, 3187590, 112200250, 2819814, 46238906, 140226780, 479600376, 164071437, 1072365190, 376509678, 3236136855, 7747367, 1858410, 3228093293, 3759002, 255922612, 97654181, 3569597, 220121309, 524538108, 153473832, 1070510442, 68201859, 67481235, 281986850, 93236831, 3236438093, 6717363, 2490879, 3226066489, 1927581, 170117190, 163695021, 4077909, 183279137, 217325713, 120589150, 109410171, 125229028, 79672257, 1073414640, 52343308, 110886350, 942145633, 199142285, 3233845497, 5429099, 1198650, 3225465661, 1956860, 163727638, 3724636, 15486371, 113369314, 250470830, 125868849, 9886641, 210792012, 1069990068, 808938405, 169331289, 3234538653, 7218004, 743249, 3228053662, 2226701, 113522198, 187444207, 2983299, 194077342, 577309318, 1070729630, 193233943, 209661990, 189017274, 245419076, 3235072036, 7317946, 3088147, 3226388503, 3911750, 204319372, 198577657, 1575520, 217651708, 251207809, 168442225, 119253, 145433185, 70439788, 122364547, 1072609032, 86907720, 133959861, 3237859937, 6496046, 2911785, 3225670213, 219982565, 194072582, 98145762, 177249949, 18396938, 110781762, 85982474, 16544337, 108517131, 144901850, 129821535, 193575618, 38910668, 21234330, 180299865, 65669898, 3310555214, 44354019, 367326735, 479730890, 467195733, 463764524, 435691552, 137926696, 473441323, 410581081, 486028499, 486064063, 501165564, 467572218, 480135311, 419874412, 139189869, 45669057, 37260830, 2222903613, 2620612, 3309713399, 43636377, 282685232, 467214140, 481172282, 481179356, 426123995, 417786029, 490575133, 136768075, 472285065, 409344389, 483835352, 483814867, 500575188, 467242965, 481540293, 423557989, 142180213, 44296382, 33834543, 2230557885};

us* ROUT[64] = { &R[0], &R[1], &R[2], &R[3], &R[4], &R[5], &R[6], &R[7], &R[8], &R[9], &R[10], &R[11], &R[12], &R[13], &R[14], &R[15], &R[16], &R[17], &R[18], &R[19], &R[20], &R[21], &R[22], &R[23], &R[24], &R[25], &R[26], &R[27], &R[28], &R[29], &R[30], &R[31], &R[32], &R[33], &R[34], &R[35], &R[36], &R[37], &R[38], &R[39], &R[40], &R[41], &R[42], &R[43], &R[44], &R[45], &R[46], &R[47], &R[48], &R[49], &R[50], &R[51], &R[52], &R[53], &R[54], &R[55], &R[56], &R[57], &R[58], &R[59], &R[60], &R[61], &R[62], &R[63] };
us* RIN[64] = { &R[0], &R[1], &R[2], &R[3], &R[4], &R[5], &R[6], &R[7], &R[8], &R[9], &R[10], &R[11], &R[12], &R[13], &R[14], &R[15], &R[16], &R[17], &R[18], &R[19], &R[20], &R[21], &R[22], &R[23], &R[24], &R[25], &R[26], &R[27], &R[28], &R[29], &R[30], &R[31], &R[32], &R[33], &R[34], &R[35], &R[36], &R[37], &R[38], &R[39], &R[40], &R[41], &R[42], &R[43], &R[44], &R[45], &R[46], &R[47], &R[48], &R[49], &R[50], &R[51], &R[52], &R[53], &R[54], &R[55], &R[56], &R[57], &R[58], &R[59], &R[60], &R[61], &R[62], &R[63] };

OF O[64] = {
    &f1,&f2,&f3,&f4,&f5,&f6,&f7,&f8,&f9,&f10,&f11,&f12,&f13,&f14,&f15,&f16,&f17,&f18,&f19,&f20,&f21,&f22,&f23,&f24,&f25,&f26,&f27,&f28,&f29,&f30,&f31,&f32,&f33,&f34,&f35,&f36,&f37,&f38,&f39,&f40,&f41,&f42,&f43,&f44,&f45,&f46,&f47,&f48,&f49,&f50,&f51,&f52,&f53,&f54,&f55,&f56,&f57,&f58,&f59,&f60,&f61,&f62,&f63,&f64
};

OF* OOUT[64] = { &O[0], &O[1], &O[2], &O[3], &O[4], &O[5], &O[6], &O[7], &O[8], &O[9], &O[10], &O[11], &O[12], &O[13], &O[14], &O[15], &O[16], &O[17], &O[18], &O[19], &O[20], &O[21], &O[22], &O[23], &O[24], &O[25], &O[26], &O[27], &O[28], &O[29], &O[30], &O[31], &O[32], &O[33], &O[34], &O[35], &O[36], &O[37], &O[38], &O[39], &O[40], &O[41], &O[42], &O[43], &O[44], &O[45], &O[46], &O[47], &O[48], &O[49], &O[50], &O[51], &O[52], &O[53], &O[54], &O[55], &O[56], &O[57], &O[58], &O[59], &O[60], &O[61], &O[62], &O[63] };

void setup()
{

}

void get_swap(unsigned char *oi, unsigned char *oj)
{
    RCI = (RCI + 1) % 256;
    RCJ = (RCJ + S[RCI]) % 256;
    unsigned char tmp = S[RCJ];
    S[RCJ] = S[RCI];
    S[RCI] = tmp;
    
    *oi = RCI % 64;
    *oj = RCJ % 64;
}

void scramble_O()
{
    unsigned char i, j;
    OF tmp;
    for (size_t c = 0; c < 312; ++c)
    {
        get_swap(&i, &j);
        tmp = O[j];
        O[j] = O[i];
        O[i] = tmp;
    }
}

void scramble_OOUT()
{
    unsigned char i, j;
    OF* tmp;
    for (size_t c = 0; c < 456; ++c)
    {
        get_swap(&i, &j);
        tmp = OOUT[j];
        OOUT[j] = OOUT[i];
        OOUT[i] = tmp;
    }
}

void scramble_RIN()
{
    unsigned char i, j;
    us* tmp;
    for (size_t c = 0; c < 331; ++c)
    {
        get_swap(&i, &j);
        tmp = RIN[j];
        RIN[j] = RIN[i];
        RIN[i] = tmp;
    }
}

void scramble_ROUT()
{
    unsigned char i, j;
    us* tmp;
    for (size_t c = 0; c < 599; ++c)
    {
        get_swap(&i, &j);
        tmp = ROUT[j];
        ROUT[j] = ROUT[i];
        ROUT[i] = tmp;
    }
}

us execute(us opi, us regval, us imm)
{
    // printf("%d %d %d\n", opi, regval, imm);
    us res[64];
    for (size_t i = 0; i < 64; ++i)
        res[i] = (*OOUT[i])(regval, imm);
    // printf("execute ret: %d\n", res[opi]);
    return res[opi];
}

int main()
{
    setup();

    OP* op;
    for (size_t i = 0; i < sizeof(CODE) / sizeof(OP); ++i)
    {
        op = &CODE[i];

        // printf("%d %d %d %d\n", op->OPI, op->R1, op->R2, op->IMM);
        // for (int i = 0; i < 64; ++i) printf("%d ", R[i]);
        // printf("\n");
        // printf("SKIP: %d\n", SKIP);

        us regval = *RIN[op->R2];
        us imm = op->IMM;
        A = execute(op->OPI, regval, imm);
        if (SKIP == 0) *ROUT[op->R1] = A;
        else --SKIP;

        MARK1;
        scramble(op);
        MARK2;
    }

    return 0;
}

// input
us f1(us start, us len)
{
    if (SKIP) return 0;
    if (len >> 8 != 1) return 0;
    len = len & 0xff;
    // printf("f1: %d %d\n", start, len);
    for (size_t i = 0; i < len; ++i)
    {
        if (start + i >= 64) break;
        R[start + i] = getchar();
    }
    return 0;
}

// output
us f2(us start, us len)
{
    if (SKIP) return 0;
    if (len >> 8 != 2) return 0;
    len = len & 0xff;
    // printf("f2: %d %d %d\n", start, len, R[1]);
    for (size_t i = 0; i < len; ++i)
    {
        if (start + i >= 64) break;
        putchar(R[start + i]);
    }
    return 0;
}

// mul
us f3(us x, us y)
{
    return x * y;
}

// div
us f4(us x, us y)
{
    if (y == 0) return 0;
    return x / y;
}

// xor
us f5(us x, us y)
{
    return x ^ y;
}

// and
us f6(us x, us y)
{
    return x & y;
}

// or
us f7(us x, us y)
{
    return x | y;
}

// jmp
us f8(us x, us y)
{
    if (y >> 8 != 3) return 0;
    if (SKIP) return 0;
    y = y & 0xff;
    SKIP = x == 0 ? y + 1 : 0;
    return x == 0;
}

us f9(us x, us y) { return x + y; }
us f10(us x, us y) { return (x + y) ^ 0xb044; }
us f11(us x, us y) { return (x + y) ^ 0x6c8b; }
us f12(us x, us y) { return (x + y) ^ 0x1543; }
us f13(us x, us y) { return (x + y) ^ 0xe1a2; }
us f14(us x, us y) { return (x + y) ^ 0x673a; }
us f15(us x, us y) { return (x + y) ^ 0x8c88; }
us f16(us x, us y) { return (x + y) ^ 0x31b; }
us f17(us x, us y) { return (x + y) ^ 0xde26; }
us f18(us x, us y) { return (x + y) ^ 0x19ad; }
us f19(us x, us y) { return (x + y) ^ 0xd02c; }
us f20(us x, us y) { return (x + y) ^ 0x8b4a; }
us f21(us x, us y) { return (x + y) ^ 0x2414; }
us f22(us x, us y) { return (x + y) ^ 0x71cf; }
us f23(us x, us y) { return (x + y) ^ 0x3c9b; }
us f24(us x, us y) { return (x + y) ^ 0x28be; }
us f25(us x, us y) { return (x + y) ^ 0x417d; }
us f26(us x, us y) { return (x + y) ^ 0x7b8; }
us f27(us x, us y) { return (x + y) ^ 0xba72; }
us f28(us x, us y) { return (x + y) ^ 0x6c12; }
us f29(us x, us y) { return (x + y) ^ 0xcbdb; }
us f30(us x, us y) { return (x + y) ^ 0xb61c; }
us f31(us x, us y) { return (x + y) ^ 0xe875; }
us f32(us x, us y) { return (x + y) ^ 0x61c7; }

void scramble(OP* op)
{
    if (op->C0) scramble_O();
    if (op->C1) scramble_OOUT();
    if (op->C2) scramble_RIN();
    if (op->C3) scramble_ROUT();
}

us f33(us x, us y) { return x - y; }
us f34(us x, us y) { return (x - y) ^ 0xc919; }
us f35(us x, us y) { return (x - y) ^ 0xc37b; }
us f36(us x, us y) { return (x - y) ^ 0x3045; }
us f37(us x, us y) { return (x - y) ^ 0xd258; }
us f38(us x, us y) { return (x - y) ^ 0x7fc3; }
us f39(us x, us y) { return (x - y) ^ 0x4958; }
us f40(us x, us y) { return (x - y) ^ 0xbbd8; }
us f41(us x, us y) { return (x - y) ^ 0x1f13; }
us f42(us x, us y) { return (x - y) ^ 0x7c25; }
us f43(us x, us y) { return (x - y) ^ 0x2caa; }
us f44(us x, us y) { return (x - y) ^ 0xbb11; }
us f45(us x, us y) { return (x - y) ^ 0x9d0f; }
us f46(us x, us y) { return (x - y) ^ 0xbd95; }
us f47(us x, us y) { return (x - y) ^ 0xae41; }
us f48(us x, us y) { return (x - y) ^ 0x2e8e; }
us f49(us x, us y) { return (x - y) ^ 0xcd76; }
us f50(us x, us y) { return (x - y) ^ 0xcadf; }
us f51(us x, us y) { return (x - y) ^ 0x183a; }
us f52(us x, us y) { return (x - y) ^ 0xd6c2; }
us f53(us x, us y) { return (x - y) ^ 0x7f07; }
us f54(us x, us y) { return (x - y) ^ 0xcad0; }
us f55(us x, us y) { return (x - y) ^ 0xfd16; }
us f56(us x, us y) { return (x - y) ^ 0xa2af; }

// unlock NASTY mode
us f57(us x, us y) {
    if (IS_NASTY) return 0x39a3;
    if (y == 0xcc) {
        unsigned char* NASTY_KEY = "NASTYKEY!NASTYKEY!";
        unsigned char* start = &main;

        for (size_t i = 0; i < 18; ++i)
            start[MARK1_OFFSET + 8 + i] ^= NASTY_KEY[i];

        IS_NASTY = 1;
    }

    return 0x39a3;
}

// add regs
us f58(us x, us y) { if(y >= 64) return 0; return x + *RIN[y]; }
us f59(us x, us y) { if(y >= 64) return 0; return x - *RIN[y]; }
us f60(us x, us y) { if(y >= 64) return 0; return x ^ *RIN[y]; }
us f61(us x, us y) { return 0xbd53; }
us f62(us x, us y) { return 0xd40b; }
us f63(us x, us y) { return 0x3520; }
us f64(us x, us y) { return 0x998; }